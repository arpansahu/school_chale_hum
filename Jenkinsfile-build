pipeline {
    agent any
    parameters {
        booleanParam(
            name: 'RUN_TESTS',
            defaultValue: true,
            description: 'Run tests before building. Set to false for faster builds.'
        )
    }
    environment {
        IMAGE_TAG = "${env.BUILD_ID}"
    }
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        stage('Setup Environment') {
            steps {
                script {
                    // Load .env from Jenkins credentials
                    withCredentials([file(credentialsId: 'school_chale_hum_env_file', variable: 'ENV_FILE')]) {
                        // Remove existing .env file if it exists (handles read-only files)
                        sh 'rm -f .env || true'
                        
                        def envContent = readFile(file: env.ENV_FILE)
                        writeFile(file: '.env', text: envContent)
                        
                        // Parse and set environment variables
                        def envVars = envContent.split('\n')
                        envVars.each { line ->
                            if (line && !line.startsWith('#') && line.contains('=')) {
                                def parts = line.split('=', 2)
                                def key = parts[0].trim()
                                def value = parts.length > 1 ? parts[1].trim() : ''
                                env."${key}" = value
                            }
                        }
                        
                        // Set derived variables
                        env.BUILD_PROJECT_NAME = "${env.ENV_PROJECT_NAME}_build"
                        env.PROJECT_NAME_WITH_DASH = env.ENV_PROJECT_NAME.replace('_', '-')
                        env.REGISTRY = env.DOCKER_REGISTRY
                        env.REPOSITORY = "${env.DOCKER_REPOSITORY}/${env.DOCKER_IMAGE_NAME}"
                    }
                }
            }
        }
        stage('Run Unit Tests') {
            when {
                expression { return params.RUN_TESTS }
            }
            steps {
                script {
                    echo 'Running Django Unit Tests with django-test-enforcer...'
                    
                    // Run unit tests using Django test command with test settings
                    sh """
                    docker run --rm \\
                        -v \$(pwd):/app \\
                        -w /app \\
                        --env-file .env \\
                        python:3.10.7 \\
                        bash -c 'pip install -q -r requirements.txt && \\
                                 python manage.py test --settings=school_chale_hum.test_settings --verbosity=2 --failfast'
                    """
                    
                    echo '✅ All unit tests passed successfully!'
                }
            }
        }
        stage('Run UI Tests') {
            when {
                allOf {
                    expression { return params.RUN_TESTS }
                    expression { 
                        // Only run if test_ui.py files exist
                        def uiTestFiles = sh(
                            script: 'find . -name "test_ui.py" -o -name "*_ui_test.py" | wc -l',
                            returnStdout: true
                        ).trim().toInteger()
                        return uiTestFiles > 0
                    }
                }
            }
            steps {
                script {
                    echo 'Running Playwright UI Tests with embedded Django server...'
                    
                    // Run UI tests with Playwright - starts Django server internally
                    def uiTestResult = sh(
                        script: """
                        docker run --rm \\
                            -v \$(pwd):/app \\
                            -w /app \\
                            --env-file .env \\
                            mcr.microsoft.com/playwright/python:v1.40.0-jammy \\
                            bash -c '
                                set -e
                                pip install -q -r requirements.txt
                                pip install -q pytest pytest-django pytest-playwright
                                playwright install chromium
                                
                                # Start Django server in background
                                python manage.py runserver 0.0.0.0:8013 &
                                SERVER_PID=\\\$!
                                
                                # Wait for server to be ready
                                echo "Waiting for Django server to start..."
                                for i in {1..30}; do
                                    if curl -s http://127.0.0.1:8013/ > /dev/null 2>&1; then
                                        echo "Django server is ready!"
                                        break
                                    fi
                                    sleep 1
                                done
                                
                                # Run UI tests
                                pytest **/test_ui.py -v --tb=short -x || TEST_EXIT_CODE=\\\$?
                                
                                # Stop Django server
                                kill \\\$SERVER_PID 2>/dev/null || true
                                
                                exit \\${TEST_EXIT_CODE:-0}
                            '
                        """,
                        returnStatus: true
                    )
                    
                    if (uiTestResult == 0) {
                        echo '✅ All UI tests passed successfully!'
                    } else if (uiTestResult == 125) {
                        echo '⚠️ UI tests skipped - Docker image pull failed (network issue)'
                        // Don\'t fail the build for network issues pulling the Playwright image
                    } else {
                        error "UI tests failed with exit code: ${uiTestResult}"
                    }
                }
            }
        }
        stage('Dependencies') {
            steps {
                script {
                    echo "Dependencies stage - .env already configured in Setup Environment"
                    // .env file already created in Setup Environment stage
                    sh "ls -la .env"
                }
            }
        }
        stage('Build Image') {
            steps {
                script {
                    // Ensure Docker is running and can be accessed
                    sh 'docker --version'

                    // Log the image details
                    echo "Building Docker image: ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG}"

                    // Build the Docker image
                    sh """
                    docker build -t ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG} .
                    docker tag ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG} ${REGISTRY}/${REPOSITORY}:latest
                    """
                }
            }
        }
        stage('Push Image') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'harbor-credentials', passwordVariable: 'DOCKER_REGISTRY_PASSWORD', usernameVariable: 'DOCKER_REGISTRY_USERNAME')]) {
                    script {
                        // Log in to Docker registry using environment variables without direct interpolation
                        sh '''
                        echo $DOCKER_REGISTRY_PASSWORD | docker login ${REGISTRY} -u $DOCKER_REGISTRY_USERNAME --password-stdin
                        '''

                        // Push the Docker image to the registry
                        sh '''
                        docker push ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG}
                        docker push ${REGISTRY}/${REPOSITORY}:latest
                        '''
                    }
                }
            }
        }
        stage('Sentry Release') {
            steps {
                script {
                    withCredentials([string(credentialsId: 'sentry-auth-token', variable: 'SENTRY_AUTH_TOKEN')]) {
                        sh """
                        VERSION=\$(git rev-parse HEAD)
                        sentry-cli releases -o ${env.SENTRY_ORG} -p ${env.SENTRY_PROJECT} new \$VERSION || true
                        sentry-cli releases -o ${env.SENTRY_ORG} -p ${env.SENTRY_PROJECT} set-commits --auto \$VERSION || true
                        """
                    }
                }
            }
        }
    }
    post {
        success {
            script {
                if (!currentBuild.description) {
                    currentBuild.description = "Image: ${REGISTRY}/${REPOSITORY}:${IMAGE_TAG} built and pushed successfully"
                }
                    
                    // Send success notification email using variables from .env
                    sh """curl -s \
                    -X POST \
                    --user ${env.MAIL_JET_API_KEY}:${env.MAIL_JET_API_SECRET} \
                    https://api.mailjet.com/v3.1/send \
                    -H "Content-Type:application/json" \
                    -d '{
                        "Messages":[
                                {
                                        "From": {
                                                "Email": "${env.MAIL_JET_EMAIL_ADDRESS}",
                                                "Name": "ArpanSahuOne Jenkins Notification"
                                        },
                                        "To": [
                                                {
                                                        "Email": "${env.MY_EMAIL_ADDRESS}",
                                                        "Name": "Development Team"
                                                }
                                        ],
                                        "Subject": "${currentBuild.description}",
                                        "TextPart": "Hola Development Team, your project ${currentBuild.fullDisplayName} : ${currentBuild.description}",
                                        "HTMLPart": "<h3>Hola Development Team, your project ${currentBuild.fullDisplayName} : ${currentBuild.description} </h3> <br> <p> Build Url: ${env.BUILD_URL}  </p>"
                                }
                        ]
                    }'"""

                    // Trigger deploy job
                    echo "Triggering deployment for build: ${env.BUILD_ID}"
                    build job: "${env.ENV_PROJECT_NAME}_deploy", parameters: [
                        booleanParam(name: 'DEPLOY', value: true)
                    ], wait: false
                } else {
                    echo "Build was skipped (no changes). Not triggering deployment."
                }
            }
        }
        failure {
            script {
                // Send failure notification email using variables from .env
                sh """curl -s \
                -X POST \
                --user ${env.MAIL_JET_API_KEY}:${env.MAIL_JET_API_SECRET} \
                https://api.mailjet.com/v3.1/send \
                -H "Content-Type:application/json" \
                -d '{
                    "Messages":[
                            {
                                    "From": {
                                            "Email": "${env.MAIL_JET_EMAIL_ADDRESS}",
                                            "Name": "ArpanSahuOne Jenkins Notification"
                                    },
                                    "To": [
                                            {
                                                    "Email": "${env.MY_EMAIL_ADDRESS}",
                                                    "Name": "Developer Team"
                                            }
                                    ],
                                    "Subject": "${currentBuild.fullDisplayName} build failed",
                                    "TextPart": "Hola Development Team, your project ${currentBuild.fullDisplayName} build failed ${currentBuild.description} ",
                                    "HTMLPart": "<h3>Hola Development Team, your project ${currentBuild.fullDisplayName} build failed </h3> <br> <p> ${currentBuild.description}  </p>"
                            }
                    ]
                }'"""
            }
        }
    }
}